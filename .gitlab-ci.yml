image: docker:19.03.5
services:
  - docker:19.03.5-dind

variables:
  GIT_SUBMODULE_STRATEGY: normal

stages:
  - deploy-staging
  - deploy-prod
  - undeploy-staging
  - undeploy-prod

#########################################
## Deploy common
#########################################
#
.common-deploy-script: &common-deploy-script |
  helm repo add bitnami https://charts.bitnami.com/bitnami
  helm install my-release bitnami/ghost
  sleep 10
  export APP_HOST=$(kubectl get svc --namespace $KUBE_NAMESPACE my-release-ghost --template "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}")
  export GHOST_PASSWORD=$(kubectl get secret --namespace $KUBE_NAMESPACE my-release-ghost -o jsonpath="{.data.ghost-password}" | base64 -d)
  export MARIADB_ROOT_PASSWORD=$(kubectl get secret --namespace $KUBE_NAMESPACE my-release-mariadb -o jsonpath="{.data.mariadb-root-password}" | base64 -d)
  export MARIADB_PASSWORD=$(kubectl get secret --namespace $KUBE_NAMESPACE my-release-mariadb -o jsonpath="{.data.mariadb-password}" | base64 -d)
  helm upgrade my-release bitnami/ghost --set service.type=LoadBalancer,ghostHost=$APP_HOST,ghostPassword=$GHOST_PASSWORD,mariadb.auth.rootPassword=$MARIADB_ROOT_PASSWORD,mariadb.auth.password=$MARIADB_PASSWORD
  kubectl rollout status deployment my-release-ghost

########################################
# Deploy Ghost in staging
########################################
deploy-staging:
  stage: deploy-staging
  image: alpine/k8s:1.16.15
  when: manual
  only:
    refs:
      - master
  script:
    - *common-deploy-script
  environment:
    name: staging-eks-KsVthwt8

########################################
# Deploy Ghost in prod
########################################
deploy-prod:
  stage: deploy-prod
  image: alpine/k8s:1.16.15
  when: manual
  only:
    refs:
      - master
  script:
    - *common-deploy-script
  environment:
    ##TODO:: Update the name
    name: prod-eks-KsVthwt8

########################################
# Un-deploy Ghost in staging
########################################
undeploy-staging:
  stage: undeploy-staging
  image: alpine/k8s:1.16.15
  when: manual
  only:
    refs:
      - master
  script:
    - helm uninstall my-release
  environment:
    name: staging-eks-KsVthwt8

########################################
# Un-deploy Ghost in prod
########################################
undeploy-prod:
  stage: undeploy-prod
  image: alpine/k8s:1.16.15
  when: manual
  only:
    refs:
      - master
  script:
    - helm uninstall my-release
  environment:
    ##TODO:: Update the name
    name: prod-eks-KsVthwt8
